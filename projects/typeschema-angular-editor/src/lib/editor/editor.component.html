
<ngb-alert type="danger" *ngIf="response && response.success === false">{{ response.message }}</ngb-alert>
<ngb-alert type="success" *ngIf="response && response.success === true">{{ response.message }}</ngb-alert>

<div class="btn-group" role="group">
  <button type="button" class="btn btn-primary" (click)="doSave()" *ngIf="save.observed">Save</button>
  <button type="button" class="btn btn-success" (click)="openType(typeModal)">New Type</button>
  <button type="button" class="btn btn-light" (click)="openInclude(includeModal)" *ngIf="importEnabled">Include</button>
  <button type="button" class="btn btn-light" (click)="openImport(importModal)">Import</button>
  <button type="button" class="btn btn-light" (click)="openExport(exportModal)">Export</button>
</div>

<div class="editor-type" *ngIf="specification.imports.length > 0">
  <h3 class="editor-type-name">Imports</h3>
  <table class="table editor-type-properties">
    <colgroup>
      <col width="150">
      <col width="*">
      <col width="50">
    </colgroup>
    <thead>
    <tr>
      <th>Alias</th>
      <th>Document</th>
      <th></th>
    </tr>
    </thead>
    <tbody>
    <tr *ngFor="let include of specification.imports; index as includeIndex">
      <td>{{ include.alias }}</td>
      <td><span class="badge badge-primary">{{ include.version }}</span>&nbsp;<span *ngIf="include.document">{{ include.document.user?.name }} / {{ include.document.name }}</span></td>
      <td>
        <div class="btn-group" role="group">
          <a class="btn btn-danger" (click)="deleteInclude(includeIndex)">Remove</a>
        </div>
      </td>
    </tr>
    </tbody>
  </table>
</div>

<div *ngFor="let type of specification.types; index as typeIndex" class="card editor-type" [ngClass]="{'border-primary': specification.root === typeIndex}">
  <div class="card-header editor-type-name">
    {{ type.name }}<br>
    <div class="text-secondary editor-type-description">{{ type.description }}</div>
  </div>
  <div class="card-body">
    <div [ngSwitch]="type.type">
      <ng-container *ngSwitchCase="'reference'">
        <div class="editor-type-description">Reference: {{ type.ref }}</div>
        <div class="editor-type-description" *ngIf="type.template">Template: {{ type.template }}</div>
      </ng-container>
      <ng-container *ngSwitchCase="'map'">
        <div class="editor-type-description">Reference: {{ type.ref }}</div>
      </ng-container>
      <ng-container *ngSwitchDefault>
        <table class="table table table-striped editor-type-properties">
          <colgroup>
            <col width="*">
            <col width="100">
            <col width="100">
            <col width="150">
            <col width="50">
          </colgroup>
          <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Format</th>
            <th>Reference</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let property of type.properties; index as propertyIndex">
            <td>
              <div class="editor-type-property-name">{{ property.name }}</div>
              <div class="editor-type-property-description text-secondary">{{ property.description }}</div>
            </td>
            <td>{{ property.type }}</td>
            <td>{{ property.format }}</td>
            <td>
              <ul>
                <li *ngFor="let ref of property.refs">
                  <span>{{ ref }}</span>
                </li>
              </ul>
            </td>
            <td>
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-secondary" (click)="upProperty(typeIndex, propertyIndex)"><i class="bi bi-arrow-up"></i></button>
                <button type="button" class="btn btn-secondary" (click)="downProperty(typeIndex, propertyIndex)"><i class="bi bi-arrow-down"></i></button>
                <button type="button" class="btn btn-primary" (click)="editProperty(propertyModal, typeIndex, propertyIndex)">Edit</button>
                <button type="button" class="btn btn-danger" (click)="deleteProperty(typeIndex, propertyIndex)">Remove</button>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
        <div class="btn-group" role="group">
          <a class="btn btn-success" (click)="openProperty(propertyModal, typeIndex)">New Property</a>
        </div>
      </ng-container>
    </div>
  </div>
  <div class="card-footer">
    <div class="btn-group" role="group">
      <button type="button" class="btn btn-secondary" (click)="upType(typeIndex)"><i class="bi bi-arrow-up"></i></button>
      <button type="button" class="btn btn-secondary" (click)="downType(typeIndex)"><i class="bi bi-arrow-down"></i></button>
      <button type="button" class="btn btn-primary" (click)="editType(typeModal, typeIndex)">Edit</button>
      <button type="button" class="btn btn-danger" (click)="deleteType(typeIndex)">Remove</button>
      <button *ngIf="specification.root !== typeIndex" type="button" class="btn btn-secondary" (click)="setRoot(typeIndex)">Primary</button>
    </div>
  </div>
</div>

<ng-template #typeModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Add type</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <div class="mb-3 row">
      <label for="typeType" class="col-sm-2 col-form-label fw-bold">Type</label>
      <div class="col-sm-10">
        <select id="typeType" name="typeType" class="form-select" [(ngModel)]="type.type">
          <option ngValue="object">Object</option>
          <option ngValue="map">Map</option>
          <option ngValue="reference">Reference</option>
        </select>
      </div>
    </div>
    <div class="mb-3 row">
      <label for="typeName" class="col-sm-2 col-form-label fw-bold">Name</label>
      <div class="col-sm-10">
        <input id="typeName" name="typeName" class="form-control" [(ngModel)]="type.name">
      </div>
    </div>
    <div class="mb-3 row">
      <label for="typeDescription" class="col-sm-2 col-form-label fw-bold">Description</label>
      <div class="col-sm-10">
        <input id="typeDescription" name="typeDescription" class="form-control" [(ngModel)]="type.description">
      </div>
    </div>
    <div class="mb-3 row" *ngIf="type.type === 'object'">
      <label for="typeParent" class="col-sm-2 col-form-label fw-bold">Parent</label>
      <div class="col-sm-10">
        <select id="typeParent" name="typeParent" class="form-select" [(ngModel)]="type.parent">
          <option>No parent</option>
          <optgroup label="self">
            <ng-container *ngFor="let parentType of specification.types">
              <option [ngValue]="parentType.name" *ngIf="parentType.name != type.name">{{ parentType.name }}</option>
            </ng-container>
          </optgroup>
          <optgroup label="{{include.alias}}" *ngFor="let include of specification.imports">
            <ng-container *ngFor="let parentType of include.types">
              <option [ngValue]="include.alias + ':' + parentType.name">{{ parentType.name }}</option>
            </ng-container>
          </optgroup>
        </select>
      </div>
    </div>
    <div class="mb-3 row" *ngIf="type.type === 'map'">
      <label for="mapReference" class="col-sm-2 col-form-label fw-bold">Reference</label>
      <div class="col-sm-10">
        <select id="mapReference" name="mapReference" class="form-select" [(ngModel)]="type.ref">
          <optgroup label="scalar">
            <option ngValue="string">String</option>
            <option ngValue="integer">Integer</option>
            <option ngValue="number">Number</option>
            <option ngValue="boolean">Boolean</option>
            <option ngValue="T">Generic</option>
          </optgroup>
          <optgroup label="self">
            <ng-container *ngFor="let parentType of specification.types">
              <option [ngValue]="parentType.name" *ngIf="parentType.name != type.name">{{ parentType.name }}</option>
            </ng-container>
          </optgroup>
          <optgroup label="{{include.alias}}" *ngFor="let include of specification.imports">
            <ng-container *ngFor="let parentType of include.types">
              <option [ngValue]="include.alias + ':' + parentType.name">{{ parentType.name }}</option>
            </ng-container>
          </optgroup>
        </select>
      </div>
    </div>
    <div class="mb-3 row" *ngIf="type.type === 'reference'">
      <label for="typeReference" class="col-sm-2 col-form-label fw-bold">Reference</label>
      <div class="col-sm-10">
        <select id="typeReference" name="typeReference" class="form-select" [(ngModel)]="type.ref">
          <option>No reference</option>
          <optgroup label="self">
            <ng-container *ngFor="let parentType of specification.types">
              <option [ngValue]="parentType.name" *ngIf="parentType.name != type.name">{{ parentType.name }}</option>
            </ng-container>
          </optgroup>
          <optgroup label="{{include.alias}}" *ngFor="let include of specification.imports">
            <ng-container *ngFor="let parentType of include.types">
              <option [ngValue]="include.alias + ':' + parentType.name">{{ parentType.name }}</option>
            </ng-container>
          </optgroup>
        </select>
      </div>
    </div>
    <div class="mb-3 row" *ngIf="type.type === 'reference' && hasTypeReferenceContainsGeneric(type.ref)">
      <label for="typeTemplate" class="col-sm-2 col-form-label fw-bold">Template</label>
      <div class="col-sm-10">
        <select id="typeTemplate" name="typeTemplate" class="form-select" [(ngModel)]="type.template">
          <option>No template</option>
          <optgroup label="self">
            <ng-container *ngFor="let parentType of specification.types">
              <option [ngValue]="parentType.name" *ngIf="parentType.name != type.name">{{ parentType.name }}</option>
            </ng-container>
          </optgroup>
          <optgroup label="{{include.alias}}" *ngFor="let include of specification.imports">
            <ng-container *ngFor="let parentType of include.types">
              <option [ngValue]="include.alias + ':' + parentType.name">{{ parentType.name }}</option>
            </ng-container>
          </optgroup>
        </select>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-dark" (click)="modal.close()">Save</button>
  </div>
</ng-template>

<ng-template #propertyModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Add property</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <div class="mb-3 row">
      <label for="propertyName" class="col-sm-2 col-form-label fw-bold">Name</label>
      <div class="col-sm-10">
        <input id="propertyName" name="propertyName" class="form-control" [(ngModel)]="property.name">
      </div>
    </div>
    <div class="mb-3 row">
      <label for="propertyDescription" class="col-sm-2 col-form-label fw-bold">Description</label>
      <div class="col-sm-10">
        <input id="propertyDescription" name="propertyDescription" class="form-control" [(ngModel)]="property.description">
      </div>
    </div>
    <div class="mb-3 row">
      <label for="propertyType" class="col-sm-2 col-form-label fw-bold">Type</label>
      <div class="col-sm-10">
        <select id="propertyType" name="propertyType" class="form-select" [(ngModel)]="property.type">
          <optgroup label="Scalar">
            <option ngValue="string">String</option>
            <option ngValue="integer">Integer</option>
            <option ngValue="number">Number</option>
            <option ngValue="boolean">Boolean</option>
          </optgroup>
          <optgroup label="Complex">
            <option ngValue="object">Object</option>
            <option ngValue="map">Map</option>
            <option ngValue="array">Array</option>
            <option ngValue="union">Union</option>
            <option ngValue="intersection">Intersection</option>
            <option ngValue="any">Any</option>
          </optgroup>
        </select>
      </div>
    </div>
    <div class="mb-3 row" *ngIf="property.type == 'string'">
      <label for="propertyFormat" class="col-sm-2 col-form-label fw-bold">Format</label>
      <div class="col-sm-10">
        <select id="propertyFormat" name="propertyFormat" class="form-select" [(ngModel)]="property.format">
          <option ngValue=""></option>
          <option *ngIf="property.type == 'string'" ngValue="date">Date</option>
          <option *ngIf="property.type == 'string'" ngValue="date-time">Date-Time</option>
          <option *ngIf="property.type == 'string'" ngValue="binary">Binary</option>
        </select>
      </div>
    </div>
    <div class="mb-3 row" *ngIf="property.type == 'string'">
      <label for="propertyPattern" class="col-sm-2 col-form-label fw-bold">Pattern</label>
      <div class="col-sm-10">
        <input id="propertyPattern" name="propertyPattern" type="text" class="form-control" [(ngModel)]="property.pattern">
      </div>
    </div>
    <div class="mb-3 row" *ngIf="property.type == 'string'">
      <label for="propertyMinLength" class="col-sm-2 col-form-label fw-bold">Min-Length</label>
      <div class="col-sm-10">
        <input id="propertyMinLength" name="propertyMinLength" type="number" class="form-control" [(ngModel)]="property.minLength">
      </div>
    </div>
    <div class="mb-3 row" *ngIf="property.type == 'string'">
      <label for="propertyMaxLength" class="col-sm-2 col-form-label fw-bold">Max-Length</label>
      <div class="col-sm-10">
        <input id="propertyMaxLength" name="propertyMaxLength" type="number" class="form-control" [(ngModel)]="property.maxLength">
      </div>
    </div>
    <div class="mb-3 row" *ngIf="property.type == 'integer' || property.type == 'number'">
      <label for="propertyMinimum" class="col-sm-2 col-form-label fw-bold">Minimum</label>
      <div class="col-sm-10">
        <input id="propertyMinimum" name="propertyMinimum" type="number" class="form-control" [(ngModel)]="property.minimum">
      </div>
    </div>
    <div class="mb-3 row" *ngIf="property.type == 'integer' || property.type == 'number'">
      <label for="propertyMaximum" class="col-sm-2 col-form-label fw-bold">Maximum</label>
      <div class="col-sm-10">
        <input id="propertyMaximum" name="propertyMaximum" type="number" class="form-control" [(ngModel)]="property.maximum">
      </div>
    </div>
    <div class="mb-3 row" *ngIf="property.type == 'object' || property.type == 'array' || property.type == 'map' || property.type == 'union' || property.type == 'intersection'">
      <label for="propertyReferences" class="col-sm-2 col-form-label fw-bold">References</label>
      <div class="col-sm-10">
        <select id="propertyReferences" name="propertyReferences" size="8" class="form-select" multiple="multiple" [(ngModel)]="property.refs">
          <optgroup label="scalar" *ngIf="property.type != 'object' && property.type != 'union' && property.type != 'intersection'">
            <option ngValue="string">String</option>
            <option ngValue="integer">Integer</option>
            <option ngValue="number">Number</option>
            <option ngValue="boolean">Boolean</option>
            <option ngValue="T">Generic</option>
          </optgroup>
          <optgroup label="self">
            <option *ngFor="let refType of specification.types" [ngValue]="refType.name">{{ refType.name }}</option>
          </optgroup>
          <optgroup label="{{ include.alias }}" *ngFor="let include of specification.imports">
            <ng-container *ngFor="let parentType of include.types">
              <option [ngValue]="include.alias + ':' + parentType.name" *ngIf="parentType.name != type.name">{{ parentType.name }}</option>
            </ng-container>
          </optgroup>
        </select>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-dark" (click)="modal.close()">Save</button>
  </div>
</ng-template>

<ng-template #includeModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Include</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <div class="mb-3 row">
      <label for="includeAlias" class="col-sm-2 col-form-label fw-bold">Alias</label>
      <div class="col-sm-10">
        <input id="includeAlias" name="includeAlias" class="form-control" [(ngModel)]="include.alias">
      </div>
    </div>
    <div class="mb-3 row">
      <label for="includeDocument" class="col-sm-2 col-form-label fw-bold">Document</label>
      <div class="col-sm-10">
        <input id="includeDocument" name="includeDocument" type="text" class="form-control" [class.is-invalid]="searchFailed" [(ngModel)]="include.document" [ngbTypeahead]="search" [inputFormatter]="formatter" [resultFormatter]="formatter" [editable]="false" (ngModelChange)="loadIncludeVersions()" placeholder="Document search ..." />
      </div>
    </div>
    <div class="mb-3 row">
      <label for="includeVersion" class="col-sm-2 col-form-label fw-bold">Version</label>
      <div class="col-sm-10">
        <select id="includeVersion" name="includeVersion" class="form-select" [(ngModel)]="include.version">
          <option ngValue="master">master</option>
          <option *ngFor="let version of includeVersions" [ngValue]="version">{{ version }}</option>
        </select>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-dark" (click)="modal.close()">Save</button>
  </div>
</ng-template>

<ng-template #importModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Import</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <div class="mb-3 row">
      <div class="col-sm-12">
        <textarea id="import" name="import" rows="20" class="form-control" [(ngModel)]="import"></textarea>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="modal.close()">Import</button>
  </div>
</ng-template>

<ng-template #exportModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Export</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <div class="mb-3 row">
      <div class="col-sm-12">
        <textarea id="export" name="export" rows="20" class="form-control" [(ngModel)]="export"></textarea>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="modal.close()">Close</button>
  </div>
</ng-template>
